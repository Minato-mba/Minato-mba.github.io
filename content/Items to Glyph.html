<!DOCTYPE html>
<html lang="en">
  <head>

    <link rel="preload" href="../assets/images/container.png" as="image">
    <link rel="preload" href="../assets/images/cell_image.png" as="image">
    <link rel="preload" href="../assets/images/cell_image_selected.png" as="image">
    <link rel="preload" href="../assets/images/magnifying_glass.png" as="image">
    <link rel="preload" href="../assets/images/normal_button_hover.png" as="image">
    <link rel="preload" href="../assets/images/normal_button_active.png" as="image">
    <link rel="preload" href="../assets/images/normal_button.png" as="image">
    <link rel="preload" href="../assets/images/input2.png" as="image">
    <link rel="preload" href="../assets/images/ITG.png" as="image">


    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Items to Glyph</title>
    <style>

    @font-face {
      font-family: Minecraftia;
      src: url("../assets/fonts/minecraft.otf") format("truetype");
    }
    @font-face {
      font-family: MinecraftTen;
      src: url("../assets/fonts/minecraft-ten.ttf") format("truetype");
    }
    @font-face {
      font-family: ar;
      src: url("../assets/fonts/arPix.ttf") format("truetype");
    }

      html {
        height: 100%;
      }

      body {
        image-rendering: pixelated;
        font-family: "Minecraftia", sans-serif;
        background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
          url("../assets/images/bedrock.png");
        image-rendering: pixelated;
        background-size: 10rem 10rem;
        background-color: #000000;
        justify-content: center;
        align-items: center;
        animation: moveBackground 100s linear infinite;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      
      @keyframes moveBackground {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 100vw 0;
        }
      }

      img {
        image-rendering: pixelated;
      }

      .search-container {
        position: relative;
        width: 30%;
        margin-bottom: 10px;
        padding: 10px;

      }

      #search-bar {
        color: #c6c6c6;
        font-size: 1.5rem;
        font-family: Minecraftia, sans-serif;
        text-align: left;
        width: 100%;
        height: 40px;
        padding: 2px;
        padding-left: 40px;
        box-sizing: border-box;
        outline: none;
        background: transparent;
        border: none;
        position: relative;
        z-index: 1;
      }

      .search-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-image-source: url("../assets/images/magnifying_glass.png");
        border-image-slice: 12 1 2 11 fill;
        border-width: 48px 4px 8px 44px;
        border-style: solid;
        image-rendering: pixelated;
        pointer-events: none; 
        z-index: 0;
      }

      #top_bar {
        display: flex;
        justify-content: space-between;
        justify-items:auto;
        gap: 4px;
      }

      .bar-item {
        color: #c6c6c6;
        font-size: 1.5rem;
        font-family: Minecraftia, sans-serif;
        text-align: left;
        padding: 2px;
        width: 70%;
      }

      button.bar-item {
        width: 30%;
        text-align: center;
        border-image-source: url("../assets/images/normal_button.png");
        border-image-slice: 2 2 4 2 fill;
        border-width: 4px 4px 8px 4px;
        border-style: solid;
        padding: 2px 4px;
        cursor: pointer;

        font-family: Minecraftia, sans-serif;
        color: #58585a;
      }

      input.bar-item {
        padding-left: 4px;
        color: #c6c6c6;
        border-width: 8px 4px 8px 4px;
        border-image-source: url("../assets/images/input2.png");
        border-image-slice: 2 1 2 1 fill;
      }

      button.bar-item:hover {
        border-image-source: url("../assets/images/normal_button_hover.png");
      }
      button.bar-item:active {
        border-image-source: url("../assets/images/normal_button_active.png");
        border-image-slice: 2 fill;
        border-width: 4px;
        margin-top: 4px;
      }



      div.bar-item {
        width: 50%;
        gap: 4px;
      }


      div.bar-item {
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: row;
      }

      #container {
        width: 100%;
        max-width: 1200px;
        padding: 12px;
        border-image-source: url("../assets/images/container.png");
        border-image-slice: 4 4 4 4 fill;
        border-width: 8px 8px 8px 8px;
        border-style: solid;
      }

      #image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        column-gap: 7px;
        overflow: hidden;
      }

      .image-container {
        position: relative;
        width: 100%;
        padding-bottom: 100%; 
        border-image-source: url("../assets/images/cell_image.png");
        border-image-slice: 2 2 4 2 fill;
        border-width: 4px 4px 8px 4px;
        border-style: solid;
        cursor: pointer;
      }

      .image-container.selected {
        border-image-source: url("../assets/images/cell_image_selected.png");
      }

      img.image-item {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        image-rendering: pixelated;
      }

      button:hover {
        background-color: #5a5a5a;
      }

      ::-webkit-scrollbar {
        width: 10px;
        background-color: #3b3b3b;
      }

      ::-webkit-scrollbar-thumb {
        background-color: #5f5f5f;
        border: 1px solid #3c3c3c;
        border-radius: 5px;
      }

      canvas {
        margin-top: 20px;
        max-width: 100%;
      }

      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #1e1e1f;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Minecraftia, sans-serif;
        font-size: 2rem;
        z-index: 9999;
        flex-direction: column;
      }

      #loading_bar {
        margin-top: 40px;
        border: 4px solid #ffffff;
        height: 20px;
        width: 60%;
        box-shadow: inset 0 0 0px 4px #1e1e1f;
      }

      #progress-bar{
        width: 0%;
        box-shadow: inset 0 0 0px 4px #1e1e1f;
        background-color: white;
        height: 100%;
      }

      #loading-logo{
        width: 50%;
      }

      @media (prefers-reduced-motion: reduce) {
        body {
          animation: none;
        }
      }

      @media (max-width: 768px) {
        #search-bar, #output-name {
          font-size: 0.9rem;
        }

        button {
          padding: 8px 16px;
          font-size: 0.9rem;
        }

        #image-grid {
          grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        }
      }

      @media (max-width: 480px) {
        .bar-item {
          width: 70%;
        }
        div.bar-item {
          width: 60%;
        }
        button.bar-item {
          width: 30%;
          text-align: center;
        }
        #loading-logo{
          width: 70%;
        }

        #image-grid {
          grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <img id="loading-logo" src="../assets/images/ITG.png" alt="">
      <div id="loading_bar">
        <div id="progress-bar"></div>
      </div>
      <p id="percentage">0 %</p>
    </div>
    <div id="container">
      <div id="top_bar">
        <div class="search-container"><input type="text" id="search-bar" placeholder="" onkeyup="filterImages()"/></div>
        <div class = "bar-item">
          <input class = "bar-item" type="text" id="output-name" value="glyph_E9" placeholder="Output image name" />
          <button class = "bar-item" onclick="generateImage()">âœ“</button>
        </div>
      </div>
      <div id="image-grid"></div>
    </div>

    <canvas id="output-canvas" width="256" height="256" style="display: none;"></canvas>

    <script>
      const imageURIs = {};
      const grid = document.getElementById("image-grid");
      const selectedImages = new Set();
      let progress = 0;
      let isLowEndDevice = false;

      function detectDevicePerformance() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const lowConcurrency = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
        isLowEndDevice = isMobile || lowConcurrency;
        if (isLowEndDevice) {
          document.body.style.animation = 'none';
        }
      }

      async function loadImages() {
        detectDevicePerformance();
        document.getElementById("output-name").value = "glyph_E9.png";

        try {
          const response = await fetch(
            "https://api.github.com/repos/Mojang/bedrock-samples/contents/resource_pack/textures/items"
          );
          const data = await response.json();

          let fileIndex = 0;
          let processedFiles = 0;
          let imagesToProcess = data.filter(file => file.name.endsWith(".png"));
          let imagesToRender = [];

          const batchSize = isLowEndDevice ? 5 : 15;

          async function processBatch(startIndex) {
            const endIndex = Math.min(startIndex + batchSize, imagesToProcess.length);
            const batch = imagesToProcess.slice(startIndex, endIndex);

            for (const file of batch) {
              try {
                const imageUrl = file.download_url;
                const imageBlob = await fetch(imageUrl).then(res => res.blob());

                const imageData = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                    const img = new Image();
                    img.onload = () => {
                      if (img.width === 16 && img.height === 16) {
                        resolve({
                          name: file.name,
                          data: reader.result,
                          valid: true
                        });
                      } else {
                        console.warn(`Image ${file.name} is not 16x16, skipping.`);
                        resolve({ valid: false });
                      }
                    };
                    img.src = reader.result;
                  };
                  reader.readAsDataURL(imageBlob);
                });

                if (imageData.valid) {
                  imageURIs[imageData.name] = imageData.data;
                  imagesToRender.push(imageData.name);
                }
              } catch (err) {
                console.error(`Error processing image ${file.name}:`, err);
              }

              processedFiles++;
              updateLoadingProgress(processedFiles, imagesToProcess.length);
            }

            renderImages(imagesToRender);
            imagesToRender = [];

            if (endIndex < imagesToProcess.length) {
              setTimeout(() => processBatch(endIndex), 50);
            } else {
              finishLoading();
            }
          }

          processBatch(0);
        } catch (error) {
          console.error("Error fetching images:", error);
          document.getElementById("percentage").innerText = "Error loading images. Please refresh.";
        }
      }

      function updateLoadingProgress(processed, total) {
        progress = (processed * 100) / total;
        const bar = document.getElementById("progress-bar");
        bar.style.width = `${progress}%`;
        const percentage = document.getElementById("percentage");
        percentage.innerText = `${Math.floor(progress)} %`;
      }

      function finishLoading() {
        setTimeout(() => {
          const bar = document.getElementById("progress-bar");
          bar.style.width = `100%`;
          document.getElementById("percentage").innerText = `100 %`;

          setTimeout(() => {
            const loading = document.getElementById("loading");
            loading.style.display = "none";
          }, 1000);
        }, 500);
      }

      function renderImages(imageNames) {
        const fragment = document.createDocumentFragment();

        imageNames.forEach(image => {
          const container = document.createElement("div");
          container.classList.add("image-container");
          container.dataset.image = image;
          container.onclick = () => toggleSelect(container, image);

          const img = document.createElement("img");
          img.src = imageURIs[image];
          img.alt = image;
          img.classList.add("image-item");
          img.loading = "lazy";
          img.title = image.replace(".png", "").replaceAll("_", " ");

          container.appendChild(img);
          fragment.appendChild(container);
        });

        grid.appendChild(fragment);
      }

      function displayImage(image) {
        renderImages([image]);
      }

      function toggleSelect(container, image) {
        if (selectedImages.has(image)) {
          selectedImages.delete(image);
          container.classList.remove("selected");
        } else {
          selectedImages.add(image);
          container.classList.add("selected");
        }
      }

      function debounce(func, wait) {
        let timeout;
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      const filterImagesDebounced = debounce(function() {
        const searchValue = document
          .getElementById("search-bar")
          .value.toLowerCase();
        const imageContainers = document.getElementsByClassName("image-container");

        Array.from(imageContainers).forEach((container) => {
          const imageName = container.dataset.image;
          if (imageName.toLowerCase().includes(searchValue)) {
            container.style.display = "block";
          } else {
            container.style.display = "none";
          }
        });
      }, 200);

      function filterImages() {
        filterImagesDebounced();
      }

      async function generateImage() {
        if (selectedImages.size === 0) {
          alert("No images selected!");
          return;
        }

        const canvas = document.getElementById("output-canvas");
        const ctx = canvas.getContext("2d");
        let outputName = document.getElementById("output-name").value || "glyph_E9";

        if (!outputName.endsWith('.png')) {
          outputName += '.png';
        }

        const imagesArray = Array.from(selectedImages);
        const totalSlots = 16 * 16;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let y = 0; y < 16; y++) {
          for (let x = 0; x < 16; x++) {
            if ((y + x) % 2 === 0) {
              ctx.fillStyle = "#CCCCCC";
            } else {
              ctx.fillStyle = "#FFFFFF";
            }
            ctx.fillRect(x * 16, y * 16, 16, 16);
          }
        }

        const loadedImages = await Promise.all(
          imagesArray.map(async (image) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => resolve({ img, name: image });
              img.src = imageURIs[image];
            });
          })
        );

        loadedImages.forEach((item, i) => {
          const x = (i % 16) * 16;
          const y = Math.floor(i / 16) * 16;
          ctx.drawImage(item.img, x, y, 16, 16);
        });

        const link = document.createElement("a");
        link.download = outputName;
        link.href = canvas.toDataURL("image/png");
        link.click();
      }

      window.onload = loadImages;
    </script>
  </body>
</html>
